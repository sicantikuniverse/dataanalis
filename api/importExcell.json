import formidable from 'formidable';
import xlsx from 'xlsx';
import mysql from 'mysql2/promise';

// Nonaktifkan bodyParser karena kita pakai formidable
export const config = { api: { bodyParser: false } };

export default async function handler(req, res) {
  res.setHeader('Content-Type', 'application/json');

  try {
    if (req.method !== 'POST') {
      return res.status(405).json({ ok: false, message: 'Method not allowed' });
    }

    const form = new formidable.IncomingForm();

    form.parse(req, async (err, fields, files) => {
      if (err) {
        return res.status(500).json({ ok: false, message: 'Form parse error: ' + err.message });
      }

      if (!files.file) {
        return res.status(400).json({ ok: false, message: 'File tidak ditemukan' });
      }

      // Baca Excel
      let workbook;
      try {
        workbook = xlsx.readFile(files.file.filepath);
      } catch (e) {
        return res.status(500).json({ ok: false, message: 'Gagal membaca Excel: ' + e.message });
      }

      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const data = xlsx.utils.sheet_to_json(sheet);

      if (!data || data.length === 0) {
        return res.status(400).json({ ok: false, message: 'File Excel kosong' });
      }

      // Ambil baris pertama saja untuk test
      const row = data[0];

      let connection;
      try {
        connection = await mysql.createConnection({
          host: '163.53.195.14',
          user: 'chelsea',
          password: 'chelsea',
          database: 'dataanalis',
        });
      } catch (dbErr) {
        return res.status(500).json({ ok: false, message: 'Gagal konek MySQL: ' + dbErr.message });
      }

      try {
        // Insert 1 row untuk test
        await connection.execute(
          `INSERT INTO penjualan (kd_outlet, nm_outlet, no_doc) VALUES (?, ?, ?)`,
          [row.kd_outlet, row.nm_outlet, row.no_doc]
        );

        await connection.end();

        return res.status(200).json({
          ok: true,
          message: 'Koneksi MySQL berhasil dan 1 baris Excel tersimpan!',
          row: row
        });
      } catch (insertErr) {
        return res.status(500).json({ ok: false, message: 'Gagal insert row: ' + insertErr.message });
      }
    });

  } catch (fatal) {
    return res.status(500).json({ ok: false, message: 'Fatal error: ' + fatal.message });
  }
}
